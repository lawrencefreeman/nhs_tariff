name: Deploy Snowflake setup (Key Pair Auth)

on:
  push:
    branches:
      - dev
      - test
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Snowflake
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Snowflake CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip install --upgrade pip
          pip install snowflake-cli-labs
          snow --version

      - name: Write private key to file
        env:
          SNOWFLAKE_PRIVATE_KEY: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
        run: |
          echo "$SNOWFLAKE_PRIVATE_KEY" > private_key.p8
          chmod 600 private_key.p8

      - name: Configure Snowflake connection
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
        run: |
          echo "Creating Snowflake CLI connection..."
          snow connection add 
            --connection-name default \ --good
            --account "$SNOWFLAKE_ACCOUNT" \ --good
            --user "$SNOWFLAKE_USER" \ 
            --authenticator SNOWFLAKE_JWT \
            --private-key-file private_key.p8 \
            --role "$SNOWFLAKE_ROLE" \
            --warehouse "$SNOWFLAKE_WAREHOUSE" \
            --database "$SNOWFLAKE_DATABASE"


user = "DBT_SVC"
password = "@ehgWhALkoP3k2kKF8Z*"
host = "GHYUWTI-FO56503.snowflakecomputing.com"
region = "eu-west-2"
port = 443
database = "NHS_TARIFF_DEV"
schema = "BRONZE"
warehouse = "COMPUTE_WH"
role = "DEVELOPER"
authenticator = "jwt"
private_key_file = "/Users/loz/Projects/data_eng_projects/nhs_payment_scheme/schema_private/rsa_key.p8"
          
          echo "Testing connection..."
          snow connection test default

      - name: Run Snowflake setup scripts
        env:
          AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
          S3_ALLOWED_LOCATION: ${{ secrets.S3_ALLOWED_LOCATION }}
        run: |
          echo "Deploying Snowflake setup..."
          for file in snowflake/setup/*.sql; do
            echo "Running $file ..."
            snow sql -q "$(envsubst < $file)"
          done
